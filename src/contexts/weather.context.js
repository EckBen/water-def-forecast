import React, { createContext, useContext, useEffect, useState } from 'react';
import PropTypes from 'prop-types';
import { format, addDays, parse } from 'date-fns';

import { LocationsContext } from './locations.context';
import { ConstantsContext } from './constants.context';
import { UserInputContext } from './userInput.context';

import { runWaterDeficitModel } from '../waterDeficitModel/waterDeficitModel';

const postRequest = async (bodyObj, url) => {
  const response = await fetch(url, {
    method: 'POST',
    headers: {
      'Accept': 'application/json'
    },
    body: JSON.stringify(bodyObj),
  });

  if (!response.ok) {
    throw new Error(response.statusText);
  }

  const results = await response.json();
  return results;
};

const getRequest = async (url) => {
  const response = await fetch(url, {
    method: 'GET',
    headers: {
      'Accept': 'application/json'
    }
  });

  if (!response.ok) {
    throw new Error(response.statusText);
  }

  const results = await response.json();
  return results;
};

const processIrrigationData = (irrigationData, year, targetLength) => {
  const {
    dates_pet,
    dates_pet_fcst,
    pet,
    pet_fcst
  } = irrigationData;

  const dates = dates_pet.concat(dates_pet_fcst).map(d => `${year}-${d.replace('/','-')}`);
  const values = pet.concat(pet_fcst);
  const avgPet = values.reduce((a,b) => a + b) / values.length;

  const numDaysToFcst = targetLength - values.length;
  const finalObsDate = parse(dates[dates.length - 1], 'yyyy-MM-dd', new Date());
  for (let i = 1; i <= numDaysToFcst; i++) {
    dates.push(format(addDays(finalObsDate, i), 'yyyy-MM-dd'));
    values.push(avgPet);    
  }

  return { dates, values };
};

// Set up initial state of context
export const WeatherContext = createContext({
  waterDeficits: null
});

// Set up context provider
export const WeatherProvider = ({ children }) => {
  const { selectedLocationInfo } = useContext(LocationsContext);
  const { percentiles, fcstUrl, acisUrl, petUrlCreator, today, seasonStartYear } = useContext(ConstantsContext);
  const { userSelections } = useContext(UserInputContext);
  
  const [weatherData, setWeatherData] = useState(null);
  const [waterDeficits, setWaterDeficits] = useState(null);

  useEffect(() => {
    if (selectedLocationInfo) {
      const lngLatArr = [selectedLocationInfo.lng, selectedLocationInfo.lat];
      
      const acisBody = {
        loc: lngLatArr.join(','),
        grid: 'nrcc-model',
        sDate: `${seasonStartYear}-03-01`,
        eDate: format(today, 'yyyy-MM-dd'),
        elems: [{ name: 'pcpn' }]
      };
      const fcstBody = {
        lngLatArr,
        percentiles
      };

      (async () => {
        const [observedPrecip, forecastPrecip, irrigationData] = await Promise.all([
          postRequest(acisBody, acisUrl),
          postRequest(fcstBody, fcstUrl),
          getRequest(petUrlCreator(lngLatArr, seasonStartYear))
        ]);

        console.log('calling');

        setWeatherData({
          qpf: forecastPrecip.qpf,
          outlook: forecastPrecip.outlook,
          obsPrecip: observedPrecip.data.reduce((acc, [date, value]) => {
            acc.dates.push(date);
            acc.values.push(value);
            return acc;
          },{ dates: [], values: [] }),
          pet: processIrrigationData(irrigationData, seasonStartYear, observedPrecip.data.length + 28)
        });
      })();


      // // Sample of 15 Foothill Road, Freeville, NY on 2/5/2024
      // setWeatherData({
      //   qpf: {
      //     "dates": [
      //       "2024-02-06",
      //       "2024-02-07",
      //       "2024-02-08",
      //       "2024-02-09",
      //       "2024-02-10",
      //       "2024-02-11",
      //       "2024-02-12"
      //     ],
      //     "values": [
      //       0,
      //       0,
      //       0,
      //       0.01,
      //       0.01,
      //       0,
      //       0.01
      //     ]
      //   },
      //   outlook: {
      //     "0": [
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0
      //     ],
      //     "10": [
      //       0.01,
      //       0.01,
      //       0.01,
      //       0.01,
      //       0.01,
      //       0.01,
      //       0.01,
      //       0.01,
      //       0.01,
      //       0.01,
      //       0.01,
      //       0.01,
      //       0.01,
      //       0.01,
      //       0.02,
      //       0.02,
      //       0.02,
      //       0.02,
      //       0.02,
      //       0.02,
      //       0.02
      //     ],
      //     "25": [
      //       0.02,
      //       0.02,
      //       0.02,
      //       0.02,
      //       0.02,
      //       0.02,
      //       0.02,
      //       0.02,
      //       0.02,
      //       0.02,
      //       0.02,
      //       0.02,
      //       0.02,
      //       0.02,
      //       0.03,
      //       0.03,
      //       0.03,
      //       0.03,
      //       0.03,
      //       0.03,
      //       0.03
      //     ],
      //     "50": [
      //       0.06,
      //       0.06,
      //       0.06,
      //       0.06,
      //       0.06,
      //       0.06,
      //       0.06,
      //       0.04,
      //       0.04,
      //       0.04,
      //       0.04,
      //       0.04,
      //       0.04,
      //       0.04,
      //       0.06,
      //       0.06,
      //       0.06,
      //       0.06,
      //       0.06,
      //       0.06,
      //       0.06
      //     ],
      //     "75": [
      //       0.12,
      //       0.12,
      //       0.12,
      //       0.12,
      //       0.12,
      //       0.12,
      //       0.12,
      //       0.06,
      //       0.06,
      //       0.06,
      //       0.06,
      //       0.06,
      //       0.06,
      //       0.06,
      //       0.09,
      //       0.09,
      //       0.09,
      //       0.09,
      //       0.09,
      //       0.09,
      //       0.09
      //     ],
      //     "90": [
      //       0.22,
      //       0.22,
      //       0.22,
      //       0.22,
      //       0.22,
      //       0.22,
      //       0.22,
      //       0.09,
      //       0.09,
      //       0.09,
      //       0.09,
      //       0.09,
      //       0.09,
      //       0.09,
      //       0.13,
      //       0.13,
      //       0.13,
      //       0.13,
      //       0.13,
      //       0.13,
      //       0.13
      //     ],
      //     "100": [
      //       0.56,
      //       0.56,
      //       0.56,
      //       0.56,
      //       0.56,
      //       0.56,
      //       0.56,
      //       0.3,
      //       0.3,
      //       0.3,
      //       0.3,
      //       0.3,
      //       0.3,
      //       0.3,
      //       0.48,
      //       0.48,
      //       0.48,
      //       0.48,
      //       0.48,
      //       0.48,
      //       0.48
      //     ],
      //     "dates": [
      //       "2024-02-13",
      //       "2024-02-14",
      //       "2024-02-15",
      //       "2024-02-16",
      //       "2024-02-17",
      //       "2024-02-18",
      //       "2024-02-19",
      //       "2024-02-20",
      //       "2024-02-21",
      //       "2024-02-22",
      //       "2024-02-23",
      //       "2024-02-24",
      //       "2024-02-25",
      //       "2024-02-26",
      //       "2024-02-27",
      //       "2024-02-28",
      //       "2024-02-29",
      //       "2024-03-01",
      //       "2024-03-02",
      //       "2024-03-03",
      //       "2024-03-04"
      //     ]
      //   },
      //   obsPrecip: {
      //     "dates": [
      //       "2023-03-01",
      //       "2023-03-02",
      //       "2023-03-03",
      //       "2023-03-04",
      //       "2023-03-05",
      //       "2023-03-06",
      //       "2023-03-07",
      //       "2023-03-08",
      //       "2023-03-09",
      //       "2023-03-10",
      //       "2023-03-11",
      //       "2023-03-12",
      //       "2023-03-13",
      //       "2023-03-14",
      //       "2023-03-15",
      //       "2023-03-16",
      //       "2023-03-17",
      //       "2023-03-18",
      //       "2023-03-19",
      //       "2023-03-20",
      //       "2023-03-21",
      //       "2023-03-22",
      //       "2023-03-23",
      //       "2023-03-24",
      //       "2023-03-25",
      //       "2023-03-26",
      //       "2023-03-27",
      //       "2023-03-28",
      //       "2023-03-29",
      //       "2023-03-30",
      //       "2023-03-31",
      //       "2023-04-01",
      //       "2023-04-02",
      //       "2023-04-03",
      //       "2023-04-04",
      //       "2023-04-05",
      //       "2023-04-06",
      //       "2023-04-07",
      //       "2023-04-08",
      //       "2023-04-09",
      //       "2023-04-10",
      //       "2023-04-11",
      //       "2023-04-12",
      //       "2023-04-13",
      //       "2023-04-14",
      //       "2023-04-15",
      //       "2023-04-16",
      //       "2023-04-17",
      //       "2023-04-18",
      //       "2023-04-19",
      //       "2023-04-20",
      //       "2023-04-21",
      //       "2023-04-22",
      //       "2023-04-23",
      //       "2023-04-24",
      //       "2023-04-25",
      //       "2023-04-26",
      //       "2023-04-27",
      //       "2023-04-28",
      //       "2023-04-29",
      //       "2023-04-30",
      //       "2023-05-01",
      //       "2023-05-02",
      //       "2023-05-03",
      //       "2023-05-04",
      //       "2023-05-05",
      //       "2023-05-06",
      //       "2023-05-07",
      //       "2023-05-08",
      //       "2023-05-09",
      //       "2023-05-10",
      //       "2023-05-11",
      //       "2023-05-12",
      //       "2023-05-13",
      //       "2023-05-14",
      //       "2023-05-15",
      //       "2023-05-16",
      //       "2023-05-17",
      //       "2023-05-18",
      //       "2023-05-19",
      //       "2023-05-20",
      //       "2023-05-21",
      //       "2023-05-22",
      //       "2023-05-23",
      //       "2023-05-24",
      //       "2023-05-25",
      //       "2023-05-26",
      //       "2023-05-27",
      //       "2023-05-28",
      //       "2023-05-29",
      //       "2023-05-30",
      //       "2023-05-31",
      //       "2023-06-01",
      //       "2023-06-02",
      //       "2023-06-03",
      //       "2023-06-04",
      //       "2023-06-05",
      //       "2023-06-06",
      //       "2023-06-07",
      //       "2023-06-08",
      //       "2023-06-09",
      //       "2023-06-10",
      //       "2023-06-11",
      //       "2023-06-12",
      //       "2023-06-13",
      //       "2023-06-14",
      //       "2023-06-15",
      //       "2023-06-16",
      //       "2023-06-17",
      //       "2023-06-18",
      //       "2023-06-19",
      //       "2023-06-20",
      //       "2023-06-21",
      //       "2023-06-22",
      //       "2023-06-23",
      //       "2023-06-24",
      //       "2023-06-25",
      //       "2023-06-26",
      //       "2023-06-27",
      //       "2023-06-28",
      //       "2023-06-29",
      //       "2023-06-30",
      //       "2023-07-01",
      //       "2023-07-02",
      //       "2023-07-03",
      //       "2023-07-04",
      //       "2023-07-05",
      //       "2023-07-06",
      //       "2023-07-07",
      //       "2023-07-08",
      //       "2023-07-09",
      //       "2023-07-10",
      //       "2023-07-11",
      //       "2023-07-12",
      //       "2023-07-13",
      //       "2023-07-14",
      //       "2023-07-15",
      //       "2023-07-16",
      //       "2023-07-17",
      //       "2023-07-18",
      //       "2023-07-19",
      //       "2023-07-20",
      //       "2023-07-21",
      //       "2023-07-22",
      //       "2023-07-23",
      //       "2023-07-24",
      //       "2023-07-25",
      //       "2023-07-26",
      //       "2023-07-27",
      //       "2023-07-28",
      //       "2023-07-29",
      //       "2023-07-30",
      //       "2023-07-31",
      //       "2023-08-01",
      //       "2023-08-02",
      //       "2023-08-03",
      //       "2023-08-04",
      //       "2023-08-05",
      //       "2023-08-06",
      //       "2023-08-07",
      //       "2023-08-08",
      //       "2023-08-09",
      //       "2023-08-10",
      //       "2023-08-11",
      //       "2023-08-12",
      //       "2023-08-13",
      //       "2023-08-14",
      //       "2023-08-15",
      //       "2023-08-16",
      //       "2023-08-17",
      //       "2023-08-18",
      //       "2023-08-19",
      //       "2023-08-20",
      //       "2023-08-21",
      //       "2023-08-22",
      //       "2023-08-23",
      //       "2023-08-24",
      //       "2023-08-25",
      //       "2023-08-26",
      //       "2023-08-27",
      //       "2023-08-28",
      //       "2023-08-29",
      //       "2023-08-30",
      //       "2023-08-31",
      //       "2023-09-01",
      //       "2023-09-02",
      //       "2023-09-03",
      //       "2023-09-04",
      //       "2023-09-05",
      //       "2023-09-06",
      //       "2023-09-07",
      //       "2023-09-08",
      //       "2023-09-09",
      //       "2023-09-10",
      //       "2023-09-11",
      //       "2023-09-12",
      //       "2023-09-13",
      //       "2023-09-14",
      //       "2023-09-15",
      //       "2023-09-16",
      //       "2023-09-17",
      //       "2023-09-18",
      //       "2023-09-19",
      //       "2023-09-20",
      //       "2023-09-21",
      //       "2023-09-22",
      //       "2023-09-23",
      //       "2023-09-24",
      //       "2023-09-25",
      //       "2023-09-26",
      //       "2023-09-27",
      //       "2023-09-28",
      //       "2023-09-29",
      //       "2023-09-30",
      //       "2023-10-01",
      //       "2023-10-02",
      //       "2023-10-03",
      //       "2023-10-04",
      //       "2023-10-05",
      //       "2023-10-06",
      //       "2023-10-07",
      //       "2023-10-08",
      //       "2023-10-09",
      //       "2023-10-10",
      //       "2023-10-11",
      //       "2023-10-12",
      //       "2023-10-13",
      //       "2023-10-14",
      //       "2023-10-15",
      //       "2023-10-16",
      //       "2023-10-17",
      //       "2023-10-18",
      //       "2023-10-19",
      //       "2023-10-20",
      //       "2023-10-21",
      //       "2023-10-22",
      //       "2023-10-23",
      //       "2023-10-24",
      //       "2023-10-25",
      //       "2023-10-26",
      //       "2023-10-27",
      //       "2023-10-28",
      //       "2023-10-29",
      //       "2023-10-30",
      //       "2023-10-31",
      //       "2023-11-01",
      //       "2023-11-02",
      //       "2023-11-03",
      //       "2023-11-04",
      //       "2023-11-05",
      //       "2023-11-06",
      //       "2023-11-07",
      //       "2023-11-08",
      //       "2023-11-09",
      //       "2023-11-10",
      //       "2023-11-11",
      //       "2023-11-12",
      //       "2023-11-13",
      //       "2023-11-14",
      //       "2023-11-15",
      //       "2023-11-16",
      //       "2023-11-17",
      //       "2023-11-18",
      //       "2023-11-19",
      //       "2023-11-20",
      //       "2023-11-21",
      //       "2023-11-22",
      //       "2023-11-23",
      //       "2023-11-24",
      //       "2023-11-25",
      //       "2023-11-26",
      //       "2023-11-27",
      //       "2023-11-28",
      //       "2023-11-29",
      //       "2023-11-30",
      //       "2023-12-01",
      //       "2023-12-02",
      //       "2023-12-03",
      //       "2023-12-04",
      //       "2023-12-05",
      //       "2023-12-06",
      //       "2023-12-07",
      //       "2023-12-08",
      //       "2023-12-09",
      //       "2023-12-10",
      //       "2023-12-11",
      //       "2023-12-12",
      //       "2023-12-13",
      //       "2023-12-14",
      //       "2023-12-15",
      //       "2023-12-16",
      //       "2023-12-17",
      //       "2023-12-18",
      //       "2023-12-19",
      //       "2023-12-20",
      //       "2023-12-21",
      //       "2023-12-22",
      //       "2023-12-23",
      //       "2023-12-24",
      //       "2023-12-25",
      //       "2023-12-26",
      //       "2023-12-27",
      //       "2023-12-28",
      //       "2023-12-29",
      //       "2023-12-30",
      //       "2023-12-31",
      //       "2024-01-01",
      //       "2024-01-02",
      //       "2024-01-03",
      //       "2024-01-04",
      //       "2024-01-05",
      //       "2024-01-06",
      //       "2024-01-07",
      //       "2024-01-08",
      //       "2024-01-09",
      //       "2024-01-10",
      //       "2024-01-11",
      //       "2024-01-12",
      //       "2024-01-13",
      //       "2024-01-14",
      //       "2024-01-15",
      //       "2024-01-16",
      //       "2024-01-17",
      //       "2024-01-18",
      //       "2024-01-19",
      //       "2024-01-20",
      //       "2024-01-21",
      //       "2024-01-22",
      //       "2024-01-23",
      //       "2024-01-24",
      //       "2024-01-25",
      //       "2024-01-26",
      //       "2024-01-27",
      //       "2024-01-28",
      //       "2024-01-29",
      //       "2024-01-30",
      //       "2024-01-31",
      //       "2024-02-01",
      //       "2024-02-02",
      //       "2024-02-03",
      //       "2024-02-04",
      //       "2024-02-05"
      //     ],
      //     "values": [
      //       0.099975586,
      //       0.020004272,
      //       0,
      //       0.4399414,
      //       0.049987793,
      //       0,
      //       0,
      //       0.020004272,
      //       0,
      //       0,
      //       0.3400879,
      //       0.010002136,
      //       0.05999756,
      //       0.26000977,
      //       0.32006836,
      //       0,
      //       0.1899414,
      //       0.35009766,
      //       0.020004272,
      //       0,
      //       0,
      //       0,
      //       0.02999878,
      //       0.26000977,
      //       0.040008545,
      //       0.25,
      //       0,
      //       0.30004883,
      //       0,
      //       0.099975586,
      //       0.13000488,
      //       0.42993164,
      //       0.070007324,
      //       0,
      //       0.48999023,
      //       0,
      //       0.7597656,
      //       0.010002136,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0.18005371,
      //       0.58984375,
      //       0.090026855,
      //       0.090026855,
      //       0,
      //       0,
      //       0,
      //       0.25,
      //       0.13000488,
      //       0.11999512,
      //       0,
      //       0.11999512,
      //       0,
      //       0.3100586,
      //       0.13000488,
      //       2,
      //       0.11999512,
      //       0.14001465,
      //       0.099975586,
      //       0.010002136,
      //       0,
      //       0,
      //       0.1899414,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0.010002136,
      //       0.11999512,
      //       0,
      //       0,
      //       0,
      //       0.020004272,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0.020004272,
      //       0,
      //       0.010002136,
      //       0.18005371,
      //       0.18005371,
      //       0,
      //       0,
      //       0.7402344,
      //       0.16003418,
      //       0.6899414,
      //       0,
      //       0.54003906,
      //       0.070007324,
      //       0,
      //       0.02999878,
      //       0.010002136,
      //       0,
      //       0,
      //       0.27001953,
      //       0.040008545,
      //       0.14001465,
      //       1.1503906,
      //       0.8901367,
      //       0,
      //       0,
      //       0,
      //       0.020004272,
      //       1.1503906,
      //       0.9902344,
      //       0,
      //       0,
      //       0.040008545,
      //       0.020004272,
      //       0.05999756,
      //       0.049987793,
      //       0,
      //       0.05999756,
      //       0.4099121,
      //       0.47998047,
      //       0.049987793,
      //       0.08001709,
      //       0.25,
      //       0,
      //       0.1899414,
      //       0,
      //       0.1899414,
      //       0.22998047,
      //       0,
      //       0.33007812,
      //       0.9399414,
      //       0,
      //       0.10998535,
      //       0.22998047,
      //       0,
      //       0.4699707,
      //       0,
      //       0.049987793,
      //       0,
      //       0,
      //       0,
      //       0.13000488,
      //       0,
      //       0.5800781,
      //       0.52978516,
      //       0.2199707,
      //       0,
      //       0.4399414,
      //       0,
      //       0.05999756,
      //       0,
      //       0.44995117,
      //       0.3400879,
      //       0.02999878,
      //       0.9902344,
      //       0.02999878,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0.020004272,
      //       0.66015625,
      //       0.11999512,
      //       0,
      //       0,
      //       0.97021484,
      //       0.2800293,
      //       0,
      //       0,
      //       0,
      //       0.02999878,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0.16003418,
      //       0.020004272,
      //       0.090026855,
      //       0.26000977,
      //       0.05999756,
      //       0.42993164,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0.11999512,
      //       0.08001709,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0.08001709,
      //       0.040008545,
      //       0.10998535,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0.9301758,
      //       0.3701172,
      //       0.010002136,
      //       0,
      //       0.020004272,
      //       0,
      //       0,
      //       0,
      //       0.38989258,
      //       0.4699707,
      //       0.19995117,
      //       0,
      //       0,
      //       0,
      //       0.58984375,
      //       0.17004395,
      //       0.35009766,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0.20996094,
      //       0.5498047,
      //       0.30004883,
      //       0,
      //       0.15002441,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0.14001465,
      //       0,
      //       0.070007324,
      //       0,
      //       0,
      //       0.020004272,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0,
      //       0.54003906,
      //       0,
      //       0.010002136,
      //       0,
      //       0.38989258,
      //       0.05999756,
      //       0,
      //       0.020004272,
      //       0,
      //       0.23999023,
      //       0.2199707,
      //       0,
      //       0,
      //       0,
      //       0.2199707,
      //       0.27001953,
      //       0.8598633,
      //       0.070007324,
      //       0.040008545,
      //       0.02999878,
      //       0.010002136,
      //       0,
      //       0.040008545,
      //       0.8901367,
      //       0,
      //       0,
      //       0.02999878,
      //       0,
      //       0,
      //       0,
      //       1.6699219,
      //       0.44995117,
      //       0.020004272,
      //       0,
      //       0,
      //       0,
      //       0.099975586,
      //       0.020004272,
      //       0,
      //       0.4099121,
      //       0.47998047,
      //       0.20996094,
      //       0.040008545,
      //       0.02999878,
      //       0.02999878,
      //       0,
      //       0,
      //       0.010002136,
      //       0.040008545,
      //       0,
      //       0.5,
      //       0.13000488,
      //       0,
      //       0.89990234,
      //       0.020004272,
      //       0.010002136,
      //       0.35009766,
      //       0.070007324,
      //       0.040008545,
      //       0.020004272,
      //       0.05999756,
      //       0,
      //       0.049987793,
      //       0.16003418,
      //       0.049987793,
      //       0.049987793,
      //       0.010002136,
      //       0.25,
      //       0.9399414,
      //       0.6401367,
      //       0.049987793,
      //       0.070007324,
      //       0.6201172,
      //       0,
      //       0,
      //       0,
      //       0.020004272,
      //       0,
      //       0,
      //       0
      //     ]
      //   },
      //   pet: {
      //     "dates": [
      //       "2023-03-01",
      //       "2023-03-02",
      //       "2023-03-03",
      //       "2023-03-04",
      //       "2023-03-05",
      //       "2023-03-06",
      //       "2023-03-07",
      //       "2023-03-08",
      //       "2023-03-09",
      //       "2023-03-10",
      //       "2023-03-11",
      //       "2023-03-12",
      //       "2023-03-13",
      //       "2023-03-14",
      //       "2023-03-15",
      //       "2023-03-16",
      //       "2023-03-17",
      //       "2023-03-18",
      //       "2023-03-19",
      //       "2023-03-20",
      //       "2023-03-21",
      //       "2023-03-22",
      //       "2023-03-23",
      //       "2023-03-24",
      //       "2023-03-25",
      //       "2023-03-26",
      //       "2023-03-27",
      //       "2023-03-28",
      //       "2023-03-29",
      //       "2023-03-30",
      //       "2023-03-31",
      //       "2023-04-01",
      //       "2023-04-02",
      //       "2023-04-03",
      //       "2023-04-04",
      //       "2023-04-05",
      //       "2023-04-06",
      //       "2023-04-07",
      //       "2023-04-08",
      //       "2023-04-09",
      //       "2023-04-10",
      //       "2023-04-11",
      //       "2023-04-12",
      //       "2023-04-13",
      //       "2023-04-14",
      //       "2023-04-15",
      //       "2023-04-16",
      //       "2023-04-17",
      //       "2023-04-18",
      //       "2023-04-19",
      //       "2023-04-20",
      //       "2023-04-21",
      //       "2023-04-22",
      //       "2023-04-23",
      //       "2023-04-24",
      //       "2023-04-25",
      //       "2023-04-26",
      //       "2023-04-27",
      //       "2023-04-28",
      //       "2023-04-29",
      //       "2023-04-30",
      //       "2023-05-01",
      //       "2023-05-02",
      //       "2023-05-03",
      //       "2023-05-04",
      //       "2023-05-05",
      //       "2023-05-06",
      //       "2023-05-07",
      //       "2023-05-08",
      //       "2023-05-09",
      //       "2023-05-10",
      //       "2023-05-11",
      //       "2023-05-12",
      //       "2023-05-13",
      //       "2023-05-14",
      //       "2023-05-15",
      //       "2023-05-16",
      //       "2023-05-17",
      //       "2023-05-18",
      //       "2023-05-19",
      //       "2023-05-20",
      //       "2023-05-21",
      //       "2023-05-22",
      //       "2023-05-23",
      //       "2023-05-24",
      //       "2023-05-25",
      //       "2023-05-26",
      //       "2023-05-27",
      //       "2023-05-28",
      //       "2023-05-29",
      //       "2023-05-30",
      //       "2023-05-31",
      //       "2023-06-01",
      //       "2023-06-02",
      //       "2023-06-03",
      //       "2023-06-04",
      //       "2023-06-05",
      //       "2023-06-06",
      //       "2023-06-07",
      //       "2023-06-08",
      //       "2023-06-09",
      //       "2023-06-10",
      //       "2023-06-11",
      //       "2023-06-12",
      //       "2023-06-13",
      //       "2023-06-14",
      //       "2023-06-15",
      //       "2023-06-16",
      //       "2023-06-17",
      //       "2023-06-18",
      //       "2023-06-19",
      //       "2023-06-20",
      //       "2023-06-21",
      //       "2023-06-22",
      //       "2023-06-23",
      //       "2023-06-24",
      //       "2023-06-25",
      //       "2023-06-26",
      //       "2023-06-27",
      //       "2023-06-28",
      //       "2023-06-29",
      //       "2023-06-30",
      //       "2023-07-01",
      //       "2023-07-02",
      //       "2023-07-03",
      //       "2023-07-04",
      //       "2023-07-05",
      //       "2023-07-06",
      //       "2023-07-07",
      //       "2023-07-08",
      //       "2023-07-09",
      //       "2023-07-10",
      //       "2023-07-11",
      //       "2023-07-12",
      //       "2023-07-13",
      //       "2023-07-14",
      //       "2023-07-15",
      //       "2023-07-16",
      //       "2023-07-17",
      //       "2023-07-18",
      //       "2023-07-19",
      //       "2023-07-20",
      //       "2023-07-21",
      //       "2023-07-22",
      //       "2023-07-23",
      //       "2023-07-24",
      //       "2023-07-25",
      //       "2023-07-26",
      //       "2023-07-27",
      //       "2023-07-28",
      //       "2023-07-29",
      //       "2023-07-30",
      //       "2023-07-31",
      //       "2023-08-01",
      //       "2023-08-02",
      //       "2023-08-03",
      //       "2023-08-04",
      //       "2023-08-05",
      //       "2023-08-06",
      //       "2023-08-07",
      //       "2023-08-08",
      //       "2023-08-09",
      //       "2023-08-10",
      //       "2023-08-11",
      //       "2023-08-12",
      //       "2023-08-13",
      //       "2023-08-14",
      //       "2023-08-15",
      //       "2023-08-16",
      //       "2023-08-17",
      //       "2023-08-18",
      //       "2023-08-19",
      //       "2023-08-20",
      //       "2023-08-21",
      //       "2023-08-22",
      //       "2023-08-23",
      //       "2023-08-24",
      //       "2023-08-25",
      //       "2023-08-26",
      //       "2023-08-27",
      //       "2023-08-28",
      //       "2023-08-29",
      //       "2023-08-30",
      //       "2023-08-31",
      //       "2023-09-01",
      //       "2023-09-02",
      //       "2023-09-03",
      //       "2023-09-04",
      //       "2023-09-05",
      //       "2023-09-06",
      //       "2023-09-07",
      //       "2023-09-08",
      //       "2023-09-09",
      //       "2023-09-10",
      //       "2023-09-11",
      //       "2023-09-12",
      //       "2023-09-13",
      //       "2023-09-14",
      //       "2023-09-15",
      //       "2023-09-16",
      //       "2023-09-17",
      //       "2023-09-18",
      //       "2023-09-19",
      //       "2023-09-20",
      //       "2023-09-21",
      //       "2023-09-22",
      //       "2023-09-23",
      //       "2023-09-24",
      //       "2023-09-25",
      //       "2023-09-26",
      //       "2023-09-27",
      //       "2023-09-28",
      //       "2023-09-29",
      //       "2023-09-30",
      //       "2023-10-01",
      //       "2023-10-02",
      //       "2023-10-03",
      //       "2023-10-04",
      //       "2023-10-05",
      //       "2023-10-06",
      //       "2023-10-07",
      //       "2023-10-08",
      //       "2023-10-09",
      //       "2023-10-10",
      //       "2023-10-11",
      //       "2023-10-12",
      //       "2023-10-13",
      //       "2023-10-14",
      //       "2023-10-15",
      //       "2023-10-16",
      //       "2023-10-17",
      //       "2023-10-18",
      //       "2023-10-19",
      //       "2023-10-20",
      //       "2023-10-21",
      //       "2023-10-22",
      //       "2023-10-23",
      //       "2023-10-24",
      //       "2023-10-25",
      //       "2023-10-26",
      //       "2023-10-27",
      //       "2023-10-28",
      //       "2023-10-29",
      //       "2023-10-30",
      //       "2023-10-31",
      //       "2023-11-01",
      //       "2023-11-02",
      //       "2023-11-03",
      //       "2023-11-04",
      //       "2023-11-05",
      //       "2023-11-06",
      //       "2023-11-07",
      //       "2023-11-08",
      //       "2023-11-09",
      //       "2023-11-10",
      //       "2023-11-11",
      //       "2023-11-12",
      //       "2023-11-13",
      //       "2023-11-14",
      //       "2023-11-15",
      //       "2023-11-16",
      //       "2023-11-17",
      //       "2023-11-18",
      //       "2023-11-19",
      //       "2023-11-20",
      //       "2023-11-21",
      //       "2023-11-22",
      //       "2023-11-23",
      //       "2023-11-24",
      //       "2023-11-25",
      //       "2023-11-26",
      //       "2023-11-27",
      //       "2023-11-28",
      //       "2023-11-29",
      //       "2023-11-30",
      //       "2023-12-01",
      //       "2023-12-02",
      //       "2023-12-03",
      //       "2023-12-04",
      //       "2023-12-05",
      //       "2023-12-06",
      //       "2023-12-07",
      //       "2023-12-08",
      //       "2023-12-09",
      //       "2023-12-10",
      //       "2023-12-11",
      //       "2023-12-12",
      //       "2023-12-13",
      //       "2023-12-14",
      //       "2023-12-15",
      //       "2023-12-16",
      //       "2023-12-17",
      //       "2023-12-18",
      //       "2023-12-19",
      //       "2023-12-20",
      //       "2023-12-21",
      //       "2023-12-22",
      //       "2023-12-23",
      //       "2023-12-24",
      //       "2023-12-25",
      //       "2023-12-26",
      //       "2023-12-27",
      //       "2023-12-28",
      //       "2023-12-29",
      //       "2023-12-30",
      //       "2023-12-31",
      //       "2024-01-01",
      //       "2024-01-02",
      //       "2024-01-03",
      //       "2024-01-04",
      //       "2024-01-05",
      //       "2024-01-06",
      //       "2024-01-07",
      //       "2024-01-08",
      //       "2024-01-09",
      //       "2024-01-10",
      //       "2024-01-11",
      //       "2024-01-12",
      //       "2024-01-13",
      //       "2024-01-14",
      //       "2024-01-15",
      //       "2024-01-16",
      //       "2024-01-17",
      //       "2024-01-18",
      //       "2024-01-19",
      //       "2024-01-20",
      //       "2024-01-21",
      //       "2024-01-22",
      //       "2024-01-23",
      //       "2024-01-24",
      //       "2024-01-25",
      //       "2024-01-26",
      //       "2024-01-27",
      //       "2024-01-28",
      //       "2024-01-29",
      //       "2024-01-30",
      //       "2024-01-31",
      //       "2024-02-01",
      //       "2024-02-02",
      //       "2024-02-03",
      //       "2024-02-04",
      //       "2024-02-05",
      //       "2024-02-06",
      //       "2024-02-07",
      //       "2024-02-08",
      //       "2024-02-09",
      //       "2024-02-10",
      //       "2024-02-11",
      //       "2024-02-12",
      //       "2024-02-13",
      //       "2024-02-14",
      //       "2024-02-15",
      //       "2024-02-16",
      //       "2024-02-17",
      //       "2024-02-18",
      //       "2024-02-19",
      //       "2024-02-20",
      //       "2024-02-21",
      //       "2024-02-22",
      //       "2024-02-23",
      //       "2024-02-24",
      //       "2024-02-25",
      //       "2024-02-26",
      //       "2024-02-27",
      //       "2024-02-28",
      //       "2024-02-29",
      //       "2024-03-01",
      //       "2024-03-02",
      //       "2024-03-03",
      //       "2024-03-04"
      //     ],
      //     "values": [
      //       0.014819434843957424,
      //       0.019999999552965164,
      //       0.01710515469312668,
      //       0.03481943532824516,
      //       0.014819434843957424,
      //       0.01710515469312668,
      //       0.028323406353592873,
      //       0.010609125718474388,
      //       0.009999999776482582,
      //       0.009999999776482582,
      //       0.03192458674311638,
      //       0.007714280392974615,
      //       0.03771428018808365,
      //       0.017714280635118484,
      //       0.009390873834490776,
      //       0.03481943532824516,
      //       0.05421030893921852,
      //       0.024210307747125626,
      //       0.041315462440252304,
      //       0.01710515469312668,
      //       0.0564960278570652,
      //       0.07588690519332886,
      //       0.07481943070888519,
      //       0.027714280411601067,
      //       0.040609125047922134,
      //       0.01832340657711029,
      //       0.06421031057834625,
      //       0.06131546199321747,
      //       0.03999999910593033,
      //       0.0563647635281086,
      //       0.037772037088871,
      //       0.04406652972102165,
      //       0.07710515707731247,
      //       0.05710515379905701,
      //       0.0871051549911499,
      //       0.08466865122318268,
      //       0.08491664379835129,
      //       0.044819433242082596,
      //       0.059390872716903687,
      //       0.09000000357627869,
      //       0.10000000149011612,
      //       0.12710516154766083,
      //       0.1164960265159607,
      //       0.13421030342578888,
      //       0.16070634126663208,
      //       0.17703326046466827,
      //       0.15314283967018127,
      //       0.13963887095451355,
      //       0.04771428182721138,
      //       0.027714280411601067,
      //       0.04878174886107445,
      //       0.12360118329524994,
      //       0.16360117495059967,
      //       0.09832340478897095,
      //       0.05999999865889549,
      //       0.0707063376903534,
      //       0.07360117882490158,
      //       0.061924587935209274,
      //       0.1214662492275238,
      //       0.11024799197912216,
      //       0.03481943532824516,
      //       0.03314284235239029,
      //       0.06421031057834625,
      //       0.05000000074505806,
      //       0.043601181358098984,
      //       0.04649602621793747,
      //       0.05533185601234436,
      //       0.13060922920703888,
      //       0.13060922920703888,
      //       0.12289493530988693,
      //       0.1235041618347168,
      //       0.1428949385881424,
      //       0.16060923039913177,
      //       0.1793907731771469,
      //       0.15060922503471375,
      //       0.11121845990419388,
      //       0.14939077198505402,
      //       0.1287815421819687,
      //       0.09000000357627869,
      //       0.13350416719913483,
      //       0.12518063187599182,
      //       0.08939076960086823,
      //       0.13481935858726501,
      //       0.15289492905139923,
      //       0.1706092357635498,
      //       0.07624787837266922,
      //       0.11350416392087936,
      //       0.1463990956544876,
      //       0.17578986287117004,
      //       0.1922857016324997,
      //       0.19060923159122467,
      //       0.19121846556663513,
      //       0.20289494097232819,
      //       0.19350416958332062,
      //       0.18060922622680664,
      //       0.14411339163780212,
      //       0.13832353055477142,
      //       0.12771429121494293,
      //       0.10939077287912369,
      //       0.1071050688624382,
      //       0.06481936573982239,
      //       0.07664705067873001,
      //       0.1260378211736679,
      //       0.15984877943992615,
      //       0.06771429628133774,
      //       0.1216764748096466,
      //       0.05289493501186371,
      //       0.12542858719825745,
      //       0.05999999865889549,
      //       0.11228570342063904,
      //       0.11253365874290466,
      //       0.1825336515903473,
      //       0.14893275499343872,
      //       0.1401512175798416,
      //       0.12411339581012726,
      //       0.07954198867082596,
      //       0.09289493411779404,
      //       0.14000000059604645,
      //       0.09771429747343063,
      //       0.10243692249059677,
      //       0.057105064392089844,
      //       0.147714301943779,
      //       0.16421012580394745,
      //       0.11746633797883987,
      //       0.09710506349802017,
      //       0.0987815409898758,
      //       0.14472262561321259,
      //       0.19060923159122467,
      //       0.19289493560791016,
      //       0.139390766620636,
      //       0.17167647182941437,
      //       0.09000000357627869,
      //       0.09984878450632095,
      //       0.17710506916046143,
      //       0.13771429657936096,
      //       0.12999999523162842,
      //       0.16603782773017883,
      //       0.17228570580482483,
      //       0.11457140743732452,
      //       0.15289492905139923,
      //       0.11999999731779099,
      //       0.14472262561321259,
      //       0.16350416839122772,
      //       0.10289493203163147,
      //       0.15000000596046448,
      //       0.17832352221012115,
      //       0.12710507214069366,
      //       0.10954198986291885,
      //       0.1671050637960434,
      //       0.08624788373708725,
      //       0.1622857004404068,
      //       0.08710506558418274,
      //       0.13350416719913483,
      //       0.12411339581012726,
      //       0.13121846318244934,
      //       0.1599999964237213,
      //       0.13649582862854004,
      //       0.1273530274629593,
      //       0.12639909982681274,
      //       0.16939076781272888,
      //       0.10481936484575272,
      //       0.0493907704949379,
      //       0.12289493530988693,
      //       0.0771050676703453,
      //       0.12228570133447647,
      //       0.1128949373960495,
      //       0.11939077079296112,
      //       0.13106724619865417,
      //       0.05999999865889549,
      //       0.0935041680932045,
      //       0.0877142995595932,
      //       0.06228570267558098,
      //       0.10396217554807663,
      //       0.14481936395168304,
      //       0.09518063813447952,
      //       0.1283235251903534,
      //       0.10121846199035645,
      //       0.04289493337273598,
      //       0.05060923099517822,
      //       0.10289493203163147,
      //       0.10999999940395355,
      //       0.05243692174553871,
      //       0.06518063694238663,
      //       0.05685710906982422,
      //       0.10121846199035645,
      //       0.14000000059604645,
      //       0.1128949373960495,
      //       0.13771429657936096,
      //       0.139390766620636,
      //       0.14000000059604645,
      //       0.1406092345714569,
      //       0.10563865303993225,
      //       0.09756308048963547,
      //       0.0635041669011116,
      //       0.05939076840877533,
      //       0.04710506647825241,
      //       0.09578986465930939,
      //       0.08228570222854614,
      //       0.07939077168703079,
      //       0.0983235239982605,
      //       0.09060923010110855,
      //       0.060609228909015656,
      //       0.07000000029802322,
      //       0.07106724381446838,
      //       0.09710506349802017,
      //       0.10060922801494598,
      //       0.09060923010110855,
      //       0.05542859435081482,
      //       0.039390768855810165,
      //       0.03954198956489563,
      //       0.051218461245298386,
      //       0.0877142995595932,
      //       0.07939077168703079,
      //       0.07192442566156387,
      //       0.07121846079826355,
      //       0.09000000357627869,
      //       0.0877142995595932,
      //       0.1022857055068016,
      //       0.10060922801494598,
      //       0.07999999821186066,
      //       0.042285703122615814,
      //       0.02771429717540741,
      //       0.029999999329447746,
      //       0.020609229803085327,
      //       0.0251806378364563,
      //       0.02121846191585064,
      //       0.05878153815865517,
      //       0.03121846169233322,
      //       0.02771429717540741,
      //       0.020609229803085327,
      //       0.029390769079327583,
      //       0.029390769079327583,
      //       0.029390769079327583,
      //       0.03999999910593033,
      //       0.029390769079327583,
      //       0.009999999776482582,
      //       0.009999999776482582,
      //       0.03999999910593033,
      //       0.05060923099517822,
      //       0.05999999865889549,
      //       0.058172307908535004,
      //       0.04396217688918114,
      //       0.022894933819770813,
      //       0.019999999552965164,
      //       0.009999999776482582,
      //       0.029999999329447746,
      //       0.02228570356965065,
      //       0.029390769079327583,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623,
      //       0.09153268260753623
      //     ]
      //   }
      // });
    }
  }, [selectedLocationInfo, fcstUrl, acisUrl, petUrlCreator, percentiles, today, seasonStartYear]);

  useEffect(() => {
    if (userSelections && weatherData && today && seasonStartYear) {
      const {
        waterCapacity,
        cropType,
        plantDate,
      } = userSelections;
      const {
        qpf,
        outlook,
        obsPrecip,
        pet
      } = weatherData;

      const plantDateStr = format(plantDate, 'yyyy-MM-dd');
      const modelInitDate = obsPrecip.dates[0];

      const observed = [...obsPrecip.values];
      let nullDays = 0;
      while (observed[observed.length - 1] === -999) {
        observed.pop();
        nullDays++;
      }

      let initDeficit = 0;
      let startPetIdx = 0;
      let endPetIdx = observed.length;
      const { deficitDaily: observedDeficits } = runWaterDeficitModel(observed,pet.values.slice(startPetIdx, endPetIdx),initDeficit,modelInitDate,plantDateStr,waterCapacity,cropType,false);

      initDeficit = observedDeficits[observedDeficits.length - 1];
      startPetIdx = endPetIdx + nullDays;
      endPetIdx = startPetIdx + qpf.values.length;

      const { deficitDaily: qpfDeficits } = runWaterDeficitModel(qpf.values,pet.values.slice(startPetIdx, endPetIdx),initDeficit,modelInitDate,plantDateStr,waterCapacity,cropType,true);

      initDeficit = qpfDeficits[qpfDeficits.length - 1];
      startPetIdx = endPetIdx;
      endPetIdx = pet.values.length;

      const percentileDefs = percentiles.reduce((acc,percentile) => {
        const { deficitDaily } = runWaterDeficitModel(outlook[percentile],pet.values.slice(startPetIdx, endPetIdx),initDeficit,modelInitDate,plantDateStr,waterCapacity,cropType,true);
        acc[percentile] = Array(startPetIdx).fill(null).concat(deficitDaily);
        return acc;
      }, {});

      setWaterDeficits({
        dates: pet.dates,
        observed: observedDeficits,
        qpf: Array(observedDeficits.length + nullDays).fill(null).concat(qpfDeficits),
        percentileDeficits: percentileDefs,
        waterCapacity
      });
    }
  }, [weatherData, userSelections, today, seasonStartYear, percentiles]);
  
  const value = {
    waterDeficits
  };
  return (
    <WeatherContext.Provider value={value}>
      {children}
    </WeatherContext.Provider>
  );
};

WeatherProvider.propTypes = {
  children: PropTypes.node,
};
